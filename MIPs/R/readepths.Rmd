---
title: "Read coverage per locus"
output: html_notebook
date: 2018-10-05
---

Read coverage was generated by running `samtools idxstats` on each sorted bam file plus some shell trickery to add a column with the sample name and concatenated the results into file samtools.out.txt

```{bash makeInput, eval=F}
for f in `ls aligned/*.sorted.bam`; do samtools idxstats $f | awk -v f=`echo $f | cut -d '/' -f2` 'BEGIN{OFS = "\t"}{print $0,f}' | sed 's/.sorted.bam//' >> R/samtools.out.txt; done
```

load required libs

```{r}
library(dplyr)
```


Read in the data. note that samtools ends the output for each bam file with totals across all loci with an asterix in the contig name field.

```{r dat}
dat <- read.table("samtools.out.txt",
                  sep = '\t',
                  comment.char = '*',
                  col.names = c("locus",
                                "len",
                                "mapped",
                                "unmapped",
                                "sample")
                  )
```

First identify any individuals that have failed across the board.


There are a couple of individuals that have almost no reads. We van find them by storing the retun value of the boxplot()

```{r}
inds.boxplot <- with(dat, 
                     boxplot(mapped ~ sample)
                     )
```

There are a couple of individuals that have almost no reads. We get at these from the return value of the boxplot() function. Somewhat aribtrarily, find the failed sampled as those for which the upper hinge value of the boxplot is < 10.

```{r}
bad.inds <- inds.boxplot$names[inds.boxplot$stats[4,] < 10]
bad.inds
```

Filter these two out

```{r}
passed.inds <- filter(dat,
                      !(sample %in% bad.inds)
                      )
```

Also write the bad individuals to a file, for downstream analysis

```{r}
write(bad.inds, 
      file = "bad.inds.txt")

```

Now boxplot the coverage by locus

```{r}
loci.boxplot <- with(passed.inds, 
                     boxplot(mapped ~ locus))

```

Again, we can get the dud loci by finding those for which the upper hinge is a very small value, < 10

```{r}
bad.loci <- loci.boxplot$names[loci.boxplot$stats[4,] < 10]
bad.loci
```

There are 20 loci that are consistently bad. Write them to a file for downstream use.

```{r}
write(bad.loci, 
      file = "bad.loci.txt")

```

